<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Koi DB">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230056b3' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='white'>üêü</text></svg>">
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='70' x='10' font-size='80'>üêü</text></svg>">
<title>Koi Datenblatt</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; color: #333; }
  h2 { text-align: center; }
  label { display: inline-block; width: 130px; margin-top: 10px; font-weight: bold; }
  select, input[type="text"], input[type="number"] {
    padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;
  }
  select, input[list] { width: 220px; }
  #fotosNum { width: 70px; }
  #inputDate { width: 120px; }
  #qty { width: 70px; }
  #size { width: 70px; }
  #bprice, #kprice { width: 140px; }
  .foto-input { display: flex; align-items: center; }
  .foto-prefix { font-weight: bold; font-size: 18px; margin-right: 5px; color: #0056b3; }
  .price-checkbox { margin-left: 10px; }
  .price-checkbox label { width: auto; }
  .checkboxes label { width: auto; margin-right: 10px; }
  #output { margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 6px; font-weight: bold; color: #0056b3; word-break: break-word; }
  button { margin-top: 20px; padding: 12px 20px; background: #0056b3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; }
  button:hover { background: #003f8a; }
  .btn-secondary { background: #6c757d; margin-top: 10px; }
  .btn-secondary:hover { background: #5a6268; }
  .btn-copy { background: #28a745; margin-top: 10px; }
  .btn-copy:hover { background: #218838; }
  .success-msg { color: #28a745; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; display: none; text-align: center; }
  .instructions { background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 4px solid #ffc107; }
  .instructions h3 { margin-top: 0; color: #856404; }
  .price-hint { font-size: 11px; color: #666; margin-top: 2px; }
</style>
</head>
<body>

<h2>üêü Koi Datenblatt</h2>

<form id="koiForm">

  <label>Fotos:</label>
  <div class="foto-input">
    <span class="foto-prefix">26-</span>
    <input type="text" id="fotosNum" placeholder="000" pattern="\\d{1,3}" maxlength="3" required>
  </div>

  <label>Input Date:</label>
  <input type="text" id="inputDate" placeholder="YYMMDD" maxlength="6"><br>

  <label>How to Get:</label>
  <select id="howToGet">
    <option selected>Tour KZ</option>
    <option>CC Tour</option>
    <option>Online Auktion</option>
    <option>Narita web-auction</option>
    <option>Live Auktion</option>
  </select><br>

  <label>Breeder:</label>
  <input list="breeders" id="breeder" placeholder="z.B. Isa">
  <datalist id="breeders">
    <option>Aoki</option><option>Beppu</option><option>Dainichi</option><option>Dainichi (T)</option>
    <option>Genjiro</option><option>Higashi</option><option>Hiroi</option><option>Hoshikin</option>
    <option>Hosokai</option><option>Igarashi</option><option>Ikarashi</option><option>Isa</option>
    <option>Ishihara</option><option>Izumiya</option><option>Kanno</option><option>Kawakami</option>
    <option>Kibi</option><option>KK Sakai</option><option>Kondo</option><option>Konishi</option>
    <option>Maruhide</option><option>Maruju</option><option>Marusaka</option><option>Marusei</option>
  </datalist><br>

  <label>Agent:</label>
  <div class="checkboxes">
    <label><input type="checkbox" name="agent" value="KZ" checked onclick="handleAgentChange()">KZ</label>
    <label><input type="checkbox" name="agent" value="CC" onclick="handleAgentChange()">CC</label>
    <label><input type="checkbox" name="agent" value="YI" onclick="handleAgentChange()">YI</label>
  </div><br>

  <label>Description:</label>
  <input list="desc" id="description" placeholder="Variet√§t eingeben">
  <datalist id="desc">
    <option>Kohaku</option><option>Sanke</option><option>Showa</option><option>Shiro Utsuri</option>
    <option>Bekko</option><option>Asagi</option><option>Shusui</option><option>Chagoi</option>
    <option>Soragoi</option><option>Ochiba</option><option>Doitsu</option><option>Tancho</option>
    <option>Goshiki</option><option>Kujaku</option><option>Yamabuki</option><option>Platinum</option>
    <option>Gin Rin Kohaku</option><option>Kin Showa</option><option>Beni Kikokuryu</option><option>Hi Utsuri</option>
  </datalist><br>

  <label>Qty:</label>
  <input type="number" id="qty" value="1" min="1" max="999" maxlength="3"><br>

  <label>Oya:</label>
  <input type="text" id="oya"><br>

  <label>Age:</label>
  <div class="checkboxes" id="age">
    <label><input type="radio" name="age" value="1">1</label>
    <label><input type="radio" name="age" value="2">2</label>
    <label><input type="radio" name="age" value="3">3</label>
    <label><input type="radio" name="age" value="4">4</label>
    <label><input type="radio" name="age" value="5">5</label>
    <label><input type="radio" name="age" value="6">6</label>
    <label><input type="radio" name="age" value="7">7</label>
    <label><input type="radio" name="age" value="8">8</label>
  </div><br>

  <label>Sex:</label>
  <div class="checkboxes" id="sex">
    <label><input type="radio" name="sex" value="m">m</label>
    <label><input type="radio" name="sex" value="mw">mw</label>
    <label><input type="radio" name="sex" value="w" checked>w</label>
  </div><br>

  <label>Size/cm:</label>
  <input type="text" id="size" maxlength="3"><br>

  <label>B.Price:</label>
  <input type="text" id="bprice" placeholder="z.B. 365000" maxlength="7">
  <span class="price-checkbox">
    <label><input type="checkbox" id="bpricePercent" onclick="updateTitle()"> +%X</label>
  </span><br>

  <label>K.Price:</label>
  <input type="text" id="kprice" placeholder="z.B. 365000" maxlength="7"><br>

  <label>Kunde:</label>
  <input list="kunden" id="kunde" placeholder="">
  <datalist id="kunden">
    <option>KZ</option><option>CC</option>
  </datalist><br>

  <label>Bemerkungen:</label>
  <input list="remarks" id="bemerkungen" placeholder="">
  <datalist id="remarks">
    <option>Azukari</option><option>komi</option>
  </datalist><br>

  <div id="output"></div>
  <div class="success-msg" id="successMsg">‚úÖ Text kopiert! √ñffnen Sie jetzt Google Keep und f√ºgen Sie den Text ein (lange auf das Textfeld dr√ºcken ‚Üí Einf√ºgen)</div>

  <button type="button" onclick="sendToKeep()">üìã Text kopieren & Keep √∂ffnen</button>
  <button type="button" onclick="openKeepOnly()" class="btn-copy">üìù Nur Keep √∂ffnen</button>
  <button type="reset" class="btn-secondary" onclick="resetForm()">üßπ Zur√ºcksetzen</button>

</form>

<div class="instructions">
  <h3>üìå So verwenden Sie das Formular:</h3>
  <ol>
    <li>F√ºllen Sie alle gew√ºnschten Felder aus</li>
    <li>Klicken Sie auf "Text kopieren & Keep √∂ffnen"</li>
    <li>Google Keep wird automatisch ge√∂ffnet</li>
    <li>In Keep: Neue Notiz erstellen</li>
    <li>Lange auf das Textfeld dr√ºcken und "Einf√ºgen" w√§hlen</li>
  </ol>
  <p><strong>Preis-Codierung:</strong> Zahlen werden automatisch umgewandelt (z.B. 365000 ‚Üí srgt)</p>
</div>

<script>
const form = document.getElementById("koiForm");
const output = document.getElementById("output");

// Preis-Mapping
const priceMap = {
  '1': 'i', '2': 'f', '3': 's', '4': 'y', '5': 'g',
  '6': 'r', '7': 'n', '8': 'h', '9': 'k',
  '00': '2', '000': 't', '0000': 'z', '00000': '5', '000000': 'm'
};

// Initialisierung
document.getElementById("inputDate").value = new Date().toISOString().slice(2,10).replace(/-/g,'');
loadDefaults();

form.addEventListener("input", updateTitle);

function encodePrice(price) {
  if (!price) return '';
  
  let encoded = '';
  let remaining = price.toString();
  
  // Ersetze l√§ngste Nullenfolgen zuerst
  const replacements = [
    ['000000', 'm'],
    ['00000', '5'],
    ['0000', 'z'],
    ['000', 't'],
    ['00', '2']
  ];
  
  for (const [pattern, code] of replacements) {
    while (remaining.includes(pattern)) {
      remaining = remaining.replace(pattern, code);
    }
  }
  
  // Ersetze einzelne Ziffern
  for (let i = 0; i < remaining.length; i++) {
    const char = remaining[i];
    encoded += priceMap[char] || char;
  }
  
  return encoded;
}

function handleAgentChange() {
  const checkboxes = document.querySelectorAll('input[name="agent"]');
  const checked = Array.from(checkboxes).filter(cb => cb.checked);
  
  // Wenn mehr als 2 ausgew√§hlt, neueste Auswahl r√ºckg√§ngig machen
  if (checked.length > 2) {
    event.target.checked = false;
    return;
  }
  
  // KZ und CC k√∂nnen nicht zusammen ausgew√§hlt werden
  const kz = document.querySelector('input[name="agent"][value="KZ"]');
  const cc = document.querySelector('input[name="agent"][value="CC"]');
  
  if (kz.checked && cc.checked) {
    // Letzte Auswahl r√ºckg√§ngig machen
    event.target.checked = false;
    return;
  }
  
  updateTitle();
}

function getAgentValue() {
  const kz = document.querySelector('input[name="agent"][value="KZ"]');
  const cc = document.querySelector('input[name="agent"][value="CC"]');
  const yi = document.querySelector('input[name="agent"][value="YI"]');
  
  const checked = [];
  if (kz.checked) checked.push('KZ');
  if (cc.checked) checked.push('CC');
  if (yi.checked) checked.push('YI');
  
  // Wenn 2 ausgew√§hlt: X-YI Format (YI immer an zweiter Stelle)
  if (checked.length === 2) {
    const first = checked.find(v => v !== 'YI');
    return `${first}-YI`;
  }
  
  // Wenn 1 ausgew√§hlt: nur der Wert
  return checked.join(',');
}

function getCheckboxValues(name) {
  if (name === 'agent') {
    return getAgentValue();
  }
  const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
  return Array.from(checked).map(el => el.value).join(',');
}

function getRadioValue(name) {
  const selected = document.querySelector(`input[name="${name}"]:checked`);
  return selected ? selected.value : "";
}

function updateTitle() {
  const fotosComplete = '26-' + document.getElementById('fotosNum').value;
  let bpriceEncoded = encodePrice(document.getElementById('bprice').value);
  const kpriceEncoded = encodePrice(document.getElementById('kprice').value);
  
  // F√ºge +%X hinzu wenn Checkbox aktiviert
  if (document.getElementById('bpricePercent').checked) {
    bpriceEncoded += '+%X';
  }
  
  const parts = [
    fotosComplete,
    document.getElementById('inputDate').value,
    document.getElementById('howToGet').value,
    document.getElementById('breeder').value,
    getAgentValue(),
    document.getElementById('description').value,
    document.getElementById('qty').value,
    document.getElementById('oya').value,
    getRadioValue('age'),
    getRadioValue('sex'),
    document.getElementById('size').value,
    bpriceEncoded,
    kpriceEncoded,
    document.getElementById('kunde').value,
    document.getElementById('bemerkungen').value
  ];
  output.textContent = parts.join(', ');
}

function saveDefaults() {
  const defaults = {
    howToGet: document.getElementById('howToGet').value,
    breeder: document.getElementById('breeder').value,
    agent: getAgentValue(),
    description: document.getElementById('description').value,
    qty: document.getElementById('qty').value,
    oya: document.getElementById('oya').value,
    age: getRadioValue('age'),
    sex: getRadioValue('sex'),
    kunde: document.getElementById('kunde').value
  };
  
  const formData = {
    defaults: defaults,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('koiDefaults', JSON.stringify(formData));
}

function loadDefaults() {
  const saved = localStorage.getItem('koiDefaults');
  if (!saved) return;
  
  try {
    const data = JSON.parse(saved);
    const defaults = data.defaults;
    
    if (defaults.howToGet) document.getElementById('howToGet').value = defaults.howToGet;
    if (defaults.breeder) document.getElementById('breeder').value = defaults.breeder;
    if (defaults.description) document.getElementById('description').value = defaults.description;
    if (defaults.qty) document.getElementById('qty').value = defaults.qty;
    if (defaults.oya) document.getElementById('oya').value = defaults.oya;
    if (defaults.kunde) document.getElementById('kunde').value = defaults.kunde;
    
    // Agent Checkboxen - alle zuerst deaktivieren
    document.querySelectorAll('input[name="agent"]').forEach(cb => cb.checked = false);
    if (defaults.agent) {
      // Parse X-YI Format
      if (defaults.agent.includes('-')) {
        const parts = defaults.agent.split('-');
        parts.forEach(val => {
          const checkbox = document.querySelector(`input[name="agent"][value="${val}"]`);
          if (checkbox) checkbox.checked = true;
        });
      } else {
        // Einzelner Wert
        const checkbox = document.querySelector(`input[name="agent"][value="${defaults.agent}"]`);
        if (checkbox) checkbox.checked = true;
      }
    }
    
    // Age Radio
    if (defaults.age) {
      const ageRadio = document.querySelector(`input[name="age"][value="${defaults.age}"]`);
      if (ageRadio) ageRadio.checked = true;
    }
    
    // Sex Radio
    if (defaults.sex) {
      const sexRadio = document.querySelector(`input[name="sex"][value="${defaults.sex}"]`);
      if (sexRadio) sexRadio.checked = true;
    }
    
    updateTitle();
  } catch (e) {
    console.error('Fehler beim Laden der Defaults:', e);
  }
}

function getNoteContent() {
  const fotosComplete = '26-' + document.getElementById('fotosNum').value;
  const bpriceEncoded = encodePrice(document.getElementById('bprice').value);
  const kpriceEncoded = encodePrice(document.getElementById('kprice').value);
  const bemerkungen = document.getElementById('bemerkungen').value;
  
  const title = output.textContent || "Koi Datenblatt";
  
  // Body enth√§lt nur Bemerkungen
  const body = bemerkungen || "";

  return { title, body };
}

function copyToClipboard() {
  const { title, body } = getNoteContent();
  const fullText = `${title}\n\n${body}`;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(fullText).then(() => {
      showSuccess();
    }).catch(() => {
      fallbackCopy(fullText);
    });
  } else {
    fallbackCopy(fullText);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.left = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    showSuccess();
  } catch (err) {
    alert('Kopieren fehlgeschlagen. Bitte kopieren Sie den Text manuell.');
  }
  
  document.body.removeChild(textarea);
}

function showSuccess() {
  const msg = document.getElementById('successMsg');
  msg.style.display = 'block';
  setTimeout(() => { msg.style.display = 'none'; }, 5000);
}

function sendToKeep() {
  saveDefaults();
  copyToClipboard();
  setTimeout(() => {
    openKeepOnly();
  }, 500);
}

function openKeepOnly() {
  window.open('https://keep.google.com', '_blank');
}

function resetForm() {
  form.reset();
  document.getElementById("inputDate").value = new Date().toISOString().slice(2,10).replace(/-/g,'');
  document.querySelector('input[name="agent"][value="KZ"]').checked = true;
  output.textContent = "";
  document.getElementById('successMsg').style.display = 'none';
  updateTitle();
}

updateTitle();
</script>

</body>
</html>
