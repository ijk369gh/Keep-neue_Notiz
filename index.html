<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Koi DB">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230056b3' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='white'>üêü</text></svg>">
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='70' x='10' font-size='80'>üêü</text></svg>">
<title>üêü Koi Datenblatt</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; background: #f8f9fa; color: #333; font-size: 14px; }
  h2 { text-align: center; font-size: 18px; }
  label { display: inline-block; width: 110px; margin-top: 10px; font-weight: bold; font-size: 14px; }
  select, input[type="text"], input[type="number"] {
    padding: 6px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
  }
  select, input[list] { width: 220px; }
  #howToGet { width: 160px; }
  #breederSelect { width: 120px; }
  #descriptionSelect { width: 140px; }
  #oyaSelect { width: 160px; }
  #subSelect { width: 100px; }
  #fotosNum { width: 70px; }
  #inputDate { width: 120px; }
  #qty { width: 70px; }
  #ageFrom, #ageTo { width: 50px; }
  #sizeFrom, #sizeTo { width: 70px; }
  #bprice, #kprice { width: 140px; }
  .foto-input { display: flex; align-items: center; }
  .foto-prefix { font-weight: bold; font-size: 18px; margin-right: 5px; color: #0056b3; }
  .price-checkbox { margin-left: 10px; }
  .price-checkbox label { width: auto; }
  .checkboxes label { width: auto; margin-right: 8px; font-size: 14px; }
  .inline-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .inline-group .checkboxes { display: inline-flex; gap: 5px; }
  #koiShowOptions { display: none; }
  #output { margin-top: 20px; padding: 12px; background: #e7f3ff; border-radius: 6px; font-weight: bold; color: #0056b3; word-break: break-word; font-size: 13px; }
  button { margin-top: 20px; padding: 10px 16px; background: #0056b3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; width: 100%; }
  button:hover { background: #003f8a; }
  .btn-secondary { background: #6c757d; margin-top: 10px; }
  .btn-secondary:hover { background: #5a6268; }
  .btn-copy { background: #28a745; margin-top: 10px; }
  .btn-copy:hover { background: #218838; }
  .success-msg { color: #28a745; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; display: none; text-align: center; }
  .instructions { background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 4px solid #ffc107; }
  .instructions h3 { margin-top: 0; color: #856404; }
  .saved-note { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid #0056b3; }
  .saved-note-title { font-weight: bold; color: #0056b3; margin-bottom: 5px; word-break: break-word; }
  .saved-note-date { font-size: 12px; color: #666; margin-bottom: 10px; }
  .saved-note-body { white-space: pre-wrap; font-size: 14px; margin-bottom: 10px; }
  .saved-note-actions button { margin-right: 5px; padding: 5px 10px; font-size: 13px; }
  .custom-dropdown { display: none; position: absolute; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .custom-dropdown-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
  .custom-dropdown-item:hover { background: #e7f3ff; }
  .custom-dropdown-item span:first-child:hover { background: #d0e8ff; }
</style>
</head>
<body>

<h2>üêü Koi Datenblatt</h2>

<form id="koiForm">

  <label>Fotos:</label>
  <div class="foto-input" style="display:inline-block;">
    <span class="foto-prefix">26-</span>
    <input type="text" id="fotosNum" placeholder="000" pattern="\d{1,3}" maxlength="3" required>
  </div><br>

  <label>Input Date:</label>
  <input type="text" id="inputDate" placeholder="YYMMDD" maxlength="6"><br>

  <label>How to Get:</label>
  <input type="text" id="howToGet" autocomplete="off" style="width:160px;">
  <div id="howToGetDropdown" class="custom-dropdown"></div><br>

  <label>Breeder:</label>
  <input type="text" id="breederSelect" autocomplete="off" style="width:120px;">
  <div id="breederDropdown" class="custom-dropdown"></div><br>

  <label>Agent:</label>
  <span class="checkboxes" style="display:inline-block;">
    <label><input type="checkbox" name="agent" value="YI" checked>YI</label>
    <label><input type="checkbox" name="agent" value="KZ">KZ</label>
    <label><input type="checkbox" name="agent" value="CC">CC</label>
  </span><br>

  <label>Description:</label>
  <div style="display:inline-block; vertical-align:top;">
    <div class="checkboxes">
      <label><input type="checkbox" name="descPrefix" value="Ginrin">Ginrin</label>
      <label><input type="checkbox" name="descPrefix" value="Doitsu">Doitsu</label>
    </div>
    <div class="checkboxes">
      <label><input type="checkbox" name="descPrefix" value="Tancho">Tancho</label>
      <label><input type="checkbox" name="descPrefix" value="Maruten">Maruten</label>
    </div>
  </div>
  <input type="text" id="descriptionSelect" autocomplete="off" style="width:140px;">
  <div id="descriptionDropdown" class="custom-dropdown"></div><br>

  <label>Qty:</label>
  <input type="text" id="qty" value="1" pattern="\d{1,3}" maxlength="3" style="width:70px;"><br>

  <label>Oya:</label>
  <input type="text" id="oyaSelect" autocomplete="off" style="width:160px;">
  <div id="oyaDropdown" class="custom-dropdown"></div><br>

  <label>Age:</label>
  <input type="text" id="ageFrom" pattern="\d|7\+" maxlength="2" style="width:50px;">
  <span style="margin:0 5px;">-</span>
  <input type="text" id="ageTo" pattern="\d|7\+" maxlength="2" style="width:50px;"><br>

  <label>Sex:</label>
  <span class="checkboxes" style="display:inline-block;">
    <label><input type="radio" name="sex" value="m">m</label>
    <label><input type="radio" name="sex" value="mw">mw</label>
    <label><input type="radio" name="sex" value="w" checked>w</label>
  </span><br>

  <label>Size/cm:</label>
  <input type="text" id="sizeFrom" pattern="\d{1,3}" maxlength="3" style="width:70px;">
  <span style="margin:0 5px;">-</span>
  <input type="text" id="sizeTo" pattern="\d{1,3}" maxlength="3" style="width:70px;"><br>

  <label>B.Price:</label>
  <input type="text" id="bprice" pattern="\d{1,7}" maxlength="7">
  <span class="price-checkbox">
    <label><input type="checkbox" id="bpricePercent"> +%X</label>
  </span><br>

  <label>K.Price:</label>
  <input type="text" id="kprice" pattern="\d{1,7}" maxlength="7"><br>

  <label>Kunde:</label>
  <span class="checkboxes" style="display:inline-block;">
    <label><input type="radio" name="kunde" value="KZ">KZ</label>
    <label><input type="radio" name="kunde" value="CC">CC</label>
    <label><input type="radio" name="kunde" value="Andere">Andere</label>
  </span>
  <input type="text" id="kundeOther" style="display:none; width:100px; margin-left:5px;" maxlength="50">
  <span class="checkboxes" style="display:inline-block; margin-left:10px;">
    <label><input type="checkbox" id="kundeSub"> Sub:</label>
  </span>
  <div id="subContainer" style="display:none; margin-top:5px;">
    <input type="text" id="subSelect" autocomplete="off" style="width:100px;">
    <div id="subDropdown" class="custom-dropdown"></div>
  </div><br>

  <label>Bemerkungen:</label>
  <input type="text" id="bemerkungen" style="width:160px;">
  <div class="checkboxes" style="margin-top:5px;">
    <label style="width:auto;"><input type="checkbox" id="azukariCheck"> Azukari:</label>
    <input type="text" id="azukariValue" style="display:none; width:80px; margin-left:5px;" pattern="\d{1,6}" maxlength="6">
    <label style="margin-left:10px;"><input type="radio" name="azukariType" value="komi"> komi</label>
    <label><input type="radio" name="azukariType" value="komic"> komic</label>
  </div>
  
  <div style="margin-top:10px;">
    <div class="checkboxes" style="display:inline-block;">
      <label style="width:auto;"><input type="checkbox" id="koiShowCheck"> Koi-Show:</label>
      <div id="koiShowOptions" style="display:none; margin-left:10px;">
        <label><input type="checkbox" id="koiShowAJKS"> AJKS</label>
        <label><input type="checkbox" id="koiShowAJYKS"> AJYKS</label>
        <label><input type="checkbox" id="koiShowAndere"> Andere:</label>
        <input type="text" id="koiShowAndereText" style="display:none; width:80px; margin-left:5px;" maxlength="50">
      </div>
    </div>
  </div>
  
  <div style="margin-top:10px;">
    <div class="checkboxes" style="display:inline-block;">
      <label style="width:auto;"><input type="checkbox" id="gebuehrCheck"> Geb√ºhr:</label>
      <input type="text" id="gebuehrValue" style="display:none; width:80px; margin-left:5px;" pattern="\d{1,7}" maxlength="7">
      <label style="margin-left:10px;"><input type="radio" name="gebuehrType" value="komi"> komi</label>
      <label><input type="radio" name="gebuehrType" value="komic"> komic</label>
    </div>
  </div>
  
  <div id="additionalGebuehrContainer"></div>
  
  <br>

  <div id="output"></div>
  <div class="success-msg" id="successMsg">‚úÖ Text kopiert! 
  <br><strong>In Google Keep:</strong>
  <br>1. Neue Notiz erstellen (+)
  <br>2. Einf√ºgen (lange dr√ºcken)
  <br>‚Üí Erste Zeile = Titel automatisch!</div>
  <div class="success-msg" id="offlineMsg" style="background: #fff3cd; color: #856404;">üíæ Offline gespeichert! Sie k√∂nnen die Notiz sp√§ter synchronisieren.</div>

  <button type="button" onclick="sendToKeep()">üìã Text kopieren & Keep √∂ffnen</button>
  <button type="button" onclick="saveOffline()" class="btn-copy">üíæ Offline speichern</button>
  <button type="button" onclick="showSavedNotes()" class="btn-secondary">üìÇ Gespeicherte Notizen (<span id="noteCount">0</span>)</button>
  <button type="reset" class="btn-secondary" onclick="resetForm()">üßπ Zur√ºcksetzen</button>

</form>

<div id="savedNotesModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; overflow:auto;">
  <div style="background:white; margin:20px auto; max-width:800px; border-radius:8px; padding:20px;">
    <h3>üìÇ Gespeicherte Notizen (Offline)</h3>
    <div id="savedNotesList"></div>
    <button onclick="closeModal()" class="btn-secondary" style="margin-top:10px;">Schlie√üen</button>
  </div>
</div>

<div class="instructions">
  <h3>üìå So verwenden Sie das Formular:</h3>
  
  <h4>üåê Online-Modus (mit Internet):</h4>
  <ol>
    <li>F√ºllen Sie alle gew√ºnschten Felder aus</li>
    <li>Klicken Sie auf "üìã Text kopieren & Keep √∂ffnen"</li>
    <li>Google Keep wird automatisch ge√∂ffnet</li>
    <li>In Keep: Neue Notiz erstellen (+ Symbol)</li>
    <li>Lange auf das Textfeld dr√ºcken und "Einf√ºgen" w√§hlen</li>
  </ol>
  
  <h4>üíæ Offline-Modus (ohne Internet):</h4>
  <ol>
    <li>F√ºllen Sie alle gew√ºnschten Felder aus</li>
    <li>Klicken Sie auf "üíæ Offline speichern"</li>
    <li>Die Notiz wird lokal auf Ihrem Ger√§t gespeichert</li>
    <li>Sp√§ter: Klicken Sie auf "üìÇ Gespeicherte Notizen"</li>
    <li>W√§hlen Sie eine Notiz und klicken Sie auf "üìã Kopieren"</li>
    <li>√ñffnen Sie Google Keep und f√ºgen Sie die Notiz ein</li>
  </ol>
  
  <p><strong>Preis-Codierung:</strong> Zahlen werden automatisch umgewandelt (z.B. 365000 ‚Üí srgt)</p>
  <p><strong>‚ö†Ô∏è Wichtig:</strong> LocalStorage funktioniert nur in normalen Browsern, nicht in Claude Artifacts. F√ºr vollen Funktionsumfang laden Sie die Datei herunter!</p>
</div>

<script>
const form = document.getElementById("koiForm");
const output = document.getElementById("output");

const priceMap = {
  '1': 'i', '2': 'f', '3': 's', '4': 'y', '5': 'g',
  '6': 'r', '7': 'n', '8': 'h', '9': 'k',
  '00': '2', '000': 't', '0000': 'z', '00000': '5', '000000': 'm'
};

const dropdownOptions = {
  howToGet: ['Tour KZ', 'CC Tour', 'Online Auktion', 'Narita web-auction', 'Live Auktion'],
  breederSelect: ['Aoki', 'Beppu', 'Dainichi', 'Dainichi (T)', 'Genjiro', 'Higashi', 'Hiroi', 'Hoshikin', 'Hosokai', 'Igarashi', 'Ikarashi', 'Isa', 'Ishihara', 'Izumiya', 'Kanno', 'Kawakami', 'Kibi', 'KK Sakai', 'Kondo', 'Konishi', 'Maruhide', 'Maruju', 'Marusaka', 'Marusei', 'Matsue', 'Momotaro', 'Murata', 'Nagoshi', 'Narita', 'Nogami', 'Odakan', 'Ofuchi', 'Oishi', 'Omosako', 'Otsuka', 'Oyama', 'Sakai FF', 'Sakazume', 'Sekiguchi', 'Shinoda', 'Takigawa', 'Tamaura', 'Taniguchi', 'Torazo'],
  oyaSelect: ['Super Butta', 'Kinsen x Nao', 'Masako x Pandora', 'Futaba x Pandora', 'Red Card x Pandora', 'Silk Sonic', 'Miss Kyoto'],
  descriptionSelect: ['2sai selected', '2-3sai selected', '3sai selected', 'Ai Goromo', 'Aka', 'Aka Matsuba', 'Asagi', 'Bekko', 'Beni', 'Beni Kikokuryu', 'Beni Kumonryu', 'Benigoi', 'Bigscale', 'Chagoi', 'Goshiki', 'Hi', 'Hi Utsuri', 'Ki', 'Kin', 'Kin Showa', 'Kindai', 'Kohaku', 'Kujaku', 'Ochiba', 'Platinum', 'Sanke', 'Shiro Utsuri', 'Showa', 'Shusui', 'Soragoi', 'Utsuri', 'Yamabuki'],
  subSelect: ['Armbrust', 'Essel']
};

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function safeGetLocalStorage(key, defaultValue = null) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : defaultValue;
  } catch (e) {
    console.error(`Fehler beim Laden von ${key}:`, e);
    return defaultValue;
  }
}

function safeSetLocalStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
    return true;
  } catch (e) {
    console.error(`Fehler beim Speichern von ${key}:`, e);
    return false;
  }
}

function encodePrice(price) {
  if (!price || price === '0' || price === '') return '';
  
  const cleaned = price.toString().replace(/\D/g, '');
  if (!cleaned) return '';
  
  let remaining = cleaned;
  let encoded = '';
  
  const patterns = [
    ['000000', 'm'],
    ['00000', '5'],
    ['0000', 'z'],
    ['000', 't'],
    ['00', '2']
  ];
  
  while (remaining.length > 0) {
    let replaced = false;
    
    for (const [pattern, code] of patterns) {
      if (remaining.startsWith(pattern)) {
        encoded += code;
        remaining = remaining.substring(pattern.length);
        replaced = true;
        break;
      }
    }
    
    if (!replaced) {
      const char = remaining[0];
      encoded += priceMap[char] || '0';
      remaining = remaining.substring(1);
    }
  }
  
  return encoded;
}

function setupCustomDropdown(inputId, dropdownId) {
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);
  let isMouseInDropdown = false;
  let hasBeenEdited = false;
  
  const widthMap = {
    'howToGet': '160px',
    'breederSelect': '120px',
    'descriptionSelect': '140px',
    'oyaSelect': '160px',
    'subSelect': '100px'
  };
  if (widthMap[inputId]) {
    dropdown.style.width = widthMap[inputId];
  }
  
  dropdown.addEventListener('mouseenter', () => {
    isMouseInDropdown = true;
  });
  
  dropdown.addEventListener('mouseleave', () => {
    isMouseInDropdown = false;
  });
  
  if (inputId === 'descriptionSelect' || inputId === 'breederSelect' || inputId === 'howToGet' || inputId === 'oyaSelect' || inputId === 'subSelect') {
    input.addEventListener('keydown', function(e) {
      if (e.key.length === 1 && !hasBeenEdited && this.value) {
        this.value = '';
        hasBeenEdited = true;
      }
    });
    
    input.addEventListener('blur', function() {
      hasBeenEdited = false;
    });
    
    input.addEventListener('focus', function() {
      hasBeenEdited = false;
    });
  }
  
  input.addEventListener('input', function() {
    hasBeenEdited = true;
    const value = this.value.toLowerCase();
    const originalValue = this.value;
    
    let allOptions = [...dropdownOptions[inputId]];
    const customOptions = safeGetLocalStorage('customOptions', {});
    if (customOptions[inputId]) {
      allOptions = [...new Set([...allOptions, ...customOptions[inputId]])];
    }
    
    const blacklist = safeGetLocalStorage('optionsBlacklist', {});
    if (blacklist[inputId]) {
      allOptions = allOptions.filter(opt => !blacklist[inputId].includes(opt));
    }
    
    allOptions.sort((a, b) => {
      const aStartsWithNumber = /^\d/.test(a);
      const bStartsWithNumber = /^\d/.test(b);
      if (aStartsWithNumber && !bStartsWithNumber) return -1;
      if (!aStartsWithNumber && bStartsWithNumber) return 1;
      return a.localeCompare(b, 'de', { numeric: true, sensitivity: 'base' });
    });
    
    const filtered = value ? allOptions.filter(opt => 
      opt.toLowerCase().startsWith(value)
    ) : allOptions;
    
    if (filtered.length === 0 && !value) {
      dropdown.style.display = 'none';
      return;
    }
    
    dropdown.innerHTML = '';
    
    filtered.forEach(opt => {
      const div = document.createElement('div');
      div.className = 'custom-dropdown-item';
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.style.alignItems = 'center';
      
      const textSpan = document.createElement('span');
      textSpan.textContent = opt;
      textSpan.style.flex = '1';
      textSpan.style.cursor = 'pointer';
      textSpan.addEventListener('click', () => {
        input.value = opt;
        dropdown.style.display = 'none';
        hasBeenEdited = true;
        updateTitle();
      });
      
      div.appendChild(textSpan);
      
      const deleteBtn = document.createElement('span');
      deleteBtn.textContent = 'üóëÔ∏è';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.style.padding = '0 5px';
      deleteBtn.style.fontSize = '14px';
      deleteBtn.title = 'Eintrag l√∂schen';
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        const confirmDelete = confirm(`M√∂chten Sie "${opt}" wirklich l√∂schen?`);
        if (confirmDelete) {
          removeOption(inputId, opt);
          if (input.value === opt) {
            input.value = '';
            updateTitle();
          }
          setTimeout(() => {
            input.dispatchEvent(new Event('input'));
          }, 100);
        }
      });
      div.appendChild(deleteBtn);
      
      dropdown.appendChild(div);
    });
    
    if (originalValue && !allOptions.some(opt => opt.toLowerCase() === value)) {
      const div = document.createElement('div');
      div.className = 'custom-dropdown-item';
      div.style.borderTop = '2px solid #0056b3';
      div.style.fontWeight = 'bold';
      div.style.color = '#0056b3';
      div.textContent = `${originalValue} (neu hinzuf√ºgen)`;
      div.addEventListener('click', () => {
        input.value = originalValue;
        dropdown.style.display = 'none';
        hasBeenEdited = true;
        updateTitle();
      });
      dropdown.appendChild(div);
    }
    
    dropdown.style.display = 'block';
  });
  
  input.addEventListener('focus', function() {
    if (!this.value) {
      this.dispatchEvent(new Event('input'));
    }
  });
  
  input.addEventListener('blur', function() {
    setTimeout(() => {
      if (!isMouseInDropdown) {
        dropdown.style.display = 'none';
      }
    }, 150);
  });
}

function addCustomOption(inputId, value) {
  if (!value) return;
  
  const customOptions = safeGetLocalStorage('customOptions', {});
  if (!customOptions[inputId]) customOptions[inputId] = [];
  if (!customOptions[inputId].includes(value)) {
    customOptions[inputId].push(value);
    safeSetLocalStorage('customOptions', customOptions);
  }
}

function removeCustomOption(inputId, value) {
  if (!value) return;
  
  const customOptions = safeGetLocalStorage('customOptions', {});
  if (customOptions[inputId]) {
    customOptions[inputId] = customOptions[inputId].filter(opt => opt !== value);
    safeSetLocalStorage('customOptions', customOptions);
  }
}

function removeOption(inputId, value) {
  if (!value) return;
  
  removeCustomOption(inputId, value);
  
  const blacklist = safeGetLocalStorage('optionsBlacklist', {});
  if (!blacklist[inputId]) blacklist[inputId] = [];
  if (!blacklist[inputId].includes(value)) {
    blacklist[inputId].push(value);
    safeSetLocalStorage('optionsBlacklist', blacklist);
  }
}

function formatFotoNumber() {
  const input = document.getElementById('fotosNum');
  const value = input.value.replace(/\D/g, '');
  
  if (!value) return;
  
  const limitedValue = value.slice(0, 3);
  const paddedValue = limitedValue.padStart(3, '0');
  
  const usedNumbers = safeGetLocalStorage('usedFotoNumbers', []);
  
  if (usedNumbers.includes(paddedValue)) {
    let nextNumber = parseInt(paddedValue) + 1;
    
    while (usedNumbers.includes(nextNumber.toString().padStart(3, '0')) && nextNumber < 1000) {
      nextNumber++;
    }
    
    if (nextNumber >= 1000) {
      alert('‚ö†Ô∏è Alle Foto-Nummern sind bereits verwendet!');
      input.value = paddedValue;
      return;
    }
    
    const nextPadded = nextNumber.toString().padStart(3, '0');
    
    if (confirm(`Foto-Nummer ${paddedValue} wurde bereits verwendet!\n\nM√∂chten Sie die n√§chste freie Nummer ${nextPadded} verwenden?`)) {
      input.value = nextPadded;
    } else {
      input.value = paddedValue;
    }
  } else {
    input.value = paddedValue;
  }
  
  updateTitle();
}

function saveFotoNumber(number) {
  if (!number) return;
  const usedNumbers = safeGetLocalStorage('usedFotoNumbers', []);
  if (!usedNumbers.includes(number)) {
    usedNumbers.push(number);
    safeSetLocalStorage('usedFotoNumbers', usedNumbers);
  }
}

function handleAgentChange(event) {
  const checkboxes = document.querySelectorAll('input[name="agent"]');
  const checked = Array.from(checkboxes).filter(cb => cb.checked);
  
  if (checked.length > 2) {
    event.target.checked = false;
    return;
  }
  
  const kz = document.querySelector('input[name="agent"][value="KZ"]');
  const cc = document.querySelector('input[name="agent"][value="CC"]');
  
  if (kz.checked && cc.checked) {
    event.target.checked = false;
    return;
  }
  
  updateTitle();
}

function getAgentValue() {
  const kz = document.querySelector('input[name="agent"][value="KZ"]');
  const cc = document.querySelector('input[name="agent"][value="CC"]');
  const yi = document.querySelector('input[name="agent"][value="YI"]');
  
  const checked = [];
  if (kz.checked) checked.push('KZ');
  if (cc.checked) checked.push('CC');
  if (yi.checked) checked.push('YI');
  
  if (checked.length === 2) {
    const first = checked.find(v => v !== 'YI');
    return `${first}-YI`;
  }
  
  return checked.join(',');
}

function handleKundeChange() {
  const andere = document.querySelector('input[name="kunde"][value="Andere"]');
  const otherInput = document.getElementById('kundeOther');
  
  if (andere && andere.checked) {
    otherInput.style.display = 'block';
  } else {
    otherInput.style.display = 'none';
    otherInput.value = '';
  }
  updateTitle();
}

function getKundeValue() {
  const andere = document.querySelector('input[name="kunde"][value="Andere"]');
  if (andere && andere.checked) {
    return document.getElementById('kundeOther').value;
  }
  const selected = document.querySelector('input[name="kunde"]:checked');
  return selected ? selected.value : '';
}

function handleSubChange() {
  const subCheck = document.getElementById('kundeSub');
  const subContainer = document.getElementById('subContainer');
  
  if (subCheck.checked) {
    subContainer.style.display = 'block';
  } else {
    subContainer.style.display = 'none';
    document.getElementById('subSelect').value = '';
  }
  updateTitle();
}

function getSubValue() {
  const subCheck = document.getElementById('kundeSub');
  if (!subCheck.checked) return '';
  return document.getElementById('subSelect').value;
}

function handleAzukariChange() {
  const azukariCheck = document.getElementById('azukariCheck');
  const azukariValue = document.getElementById('azukariValue');
  
  if (azukariCheck.checked) {
    azukariValue.style.display = 'inline-block';
  } else {
    azukariValue.style.display = 'none';
    azukariValue.value = '';
    document.querySelectorAll('input[name="azukariType"]').forEach(rb => rb.checked = false);
  }
  updateTitle();
}

function handleGebuehrChange() {
  const gebuehrCheck = document.getElementById('gebuehrCheck');
  const gebuehrValue = document.getElementById('gebuehrValue');
  
  if (gebuehrCheck.checked) {
    gebuehrValue.style.display = 'inline-block';
  } else {
    gebuehrValue.style.display = 'none';
    gebuehrValue.value = '';
    document.querySelectorAll('input[name="gebuehrType"]').forEach(rb => rb.checked = false);
  }
  updateTitle();
}

function handleKoiShowCheck() {
  const koiShowCheck = document.getElementById('koiShowCheck');
  const koiShowOptions = document.getElementById('koiShowOptions');
  
  if (koiShowCheck.checked) {
    koiShowOptions.style.display = 'inline-block';
  } else {
    koiShowOptions.style.display = 'none';
    document.getElementById('koiShowAJKS').checked = false;
    document.getElementById('koiShowAJYKS').checked = false;
    document.getElementById('koiShowAndere').checked = false;
    document.getElementById('koiShowAndereText').style.display = 'none';
    document.getElementById('koiShowAndereText').value = '';
    
    document.getElementById('gebuehrCheck').checked = false;
    document.getElementById('gebuehrValue').style.display = 'none';
    document.getElementById('gebuehrValue').value = '';
    document.querySelectorAll('input[name="gebuehrType"]').forEach(rb => rb.checked = false);
    
    updateAdditionalGebuehrFields();
  }
  updateTitle();
}

function updateAdditionalGebuehrFields() {
  const container = document.getElementById('additionalGebuehrContainer');
  
  let count = 0;
  if (document.getElementById('koiShowAJKS').checked) count++;
  if (document.getElementById('koiShowAJYKS').checked) count++;
  if (document.getElementById('koiShowAndere').checked) count++;
  
  container.innerHTML = '';
  
  for (let i = 2; i <= count; i++) {
    const div = document.createElement('div');
    div.style.marginTop = '10px';
    div.innerHTML = `
      <div class="checkboxes" style="display:inline-block;">
        <label style="width:auto;"><input type="checkbox" id="gebuehrCheck${i}" onchange="handleAdditionalGebuehrChange(${i})"> Geb√ºhr:</label>
        <input type="text" id="gebuehrValue${i}" style="display:none; width:80px; margin-left:5px;" pattern="\\d{1,7}" maxlength="7" oninput="updateTitle()">
        <label style="margin-left:10px;"><input type="radio" name="gebuehrType${i}" value="komi" onchange="updateTitle()"> komi</label>
        <label><input type="radio" name="gebuehrType${i}" value="komic" onchange="updateTitle()"> komic</label>
      </div>
    `;
    container.appendChild(div);
  }
  
  updateTitle();
}

function handleAdditionalGebuehrChange(index) {
  const gebuehrCheck = document.getElementById(`gebuehrCheck${index}`);
  const gebuehrValue = document.getElementById(`gebuehrValue${index}`);
  
  if (gebuehrCheck.checked) {
    gebuehrValue.style.display = 'inline-block';
  } else {
    gebuehrValue.style.display = 'none';
    gebuehrValue.value = '';
    document.querySelectorAll(`input[name="gebuehrType${index}"]`).forEach(rb => rb.checked = false);
  }
  updateTitle();
}

function handleKoiShowAndereChange() {
  const andereCheck = document.getElementById('koiShowAndere');
  const andereText = document.getElementById('koiShowAndereText');
  
  if (andereCheck.checked) {
    andereText.style.display = 'inline-block';
  } else {
    andereText.style.display = 'none';
    andereText.value = '';
  }
  updateTitle();
}

function getDescriptionWithPrefix() {
  const prefixes = [];
  document.querySelectorAll('input[name="descPrefix"]:checked').forEach(cb => {
    prefixes.push(cb.value);
  });
  const variety = document.getElementById('descriptionSelect').value;
  if (prefixes.length > 0 && variety) {
    return prefixes.join(' ') + ' ' + variety;
  }
  return variety;
}

function getRadioValue(name) {
  const selected = document.querySelector(`input[name="${name}"]:checked`);
  return selected ? selected.value : "";
}

function getSizeValue() {
  const sizeFrom = document.getElementById('sizeFrom').value;
  const sizeTo = document.getElementById('sizeTo').value;
  
  if (sizeFrom && sizeTo) {
    return `${sizeFrom}-${sizeTo}`;
  } else if (sizeFrom) {
    return sizeFrom;
  } else if (sizeTo) {
    return sizeTo;
  }
  return '';
}

function getAgeValue() {
  const ageFrom = document.getElementById('ageFrom').value;
  const ageTo = document.getElementById('ageTo').value;
  
  if (ageFrom && ageTo) {
    return `${ageFrom}-${ageTo}`;
  } else if (ageFrom) {
    return ageFrom;
  } else if (ageTo) {
    return ageTo;
  }
  return '';
}

function getBemerkungenBody() {
  const parts = [];
  
  const subValue = getSubValue();
  if (subValue) {
    parts.push(`Kunde: ${subValue}`);
  }
  
  if (document.getElementById('azukariCheck').checked) {
    const azukariVal = document.getElementById('azukariValue').value;
    const currentYear = new Date().getFullYear();
    const nextYear = (currentYear + 1) % 100;
    
    const extras = [];
    if (azukariVal) {
      const encoded = encodePrice(azukariVal);
      extras.push(encoded);
    }
    
    const azukariType = document.querySelector('input[name="azukariType"]:checked');
    if (azukariType) {
      extras.push(azukariType.value);
    }
    
    if (extras.length > 0) {
      parts.push(`Azukari${nextYear} (${extras.join(', ')})`);
    } else {
      parts.push(`Azukari${nextYear}`);
    }
  }
  
  const koiShowOptions = [];
  if (document.getElementById('koiShowAJKS').checked) {
    koiShowOptions.push('AJKS');
  }
  if (document.getElementById('koiShowAJYKS').checked) {
    koiShowOptions.push('AJYKS');
  }
  if (document.getElementById('koiShowAndere').checked) {
    const andereName = document.getElementById('koiShowAndereText').value || 'Andere';
    koiShowOptions.push(andereName);
  }
  
  const currentYear = new Date().getFullYear();
  const nextYear = (currentYear + 1) % 100;
  
  if (document.getElementById('gebuehrCheck').checked && koiShowOptions.length > 0) {
    const gebuehrVal = document.getElementById('gebuehrValue').value;
    const gebuehrExtras = [];
    
    if (gebuehrVal) {
      const encoded = encodePrice(gebuehrVal);
      gebuehrExtras.push(encoded);
    }
    
    const gebuehrType = document.querySelector('input[name="gebuehrType"]:checked');
    if (gebuehrType) {
      gebuehrExtras.push(gebuehrType.value);
    }
    
    const showName = koiShowOptions[0];
    if (gebuehrExtras.length > 0) {
      parts.push(`${showName}${nextYear} (${gebuehrExtras.join(', ')})`);
    } else {
      parts.push(`${showName}${nextYear}`);
    }
  }
  
  const container = document.getElementById('additionalGebuehrContainer');
  if (container) {
    const additionalFields = container.querySelectorAll('[id^="gebuehrCheck"]');
    additionalFields.forEach((checkbox, idx) => {
      const index = idx + 2;
      const showIndex = idx + 1;
      
      if (checkbox.checked && koiShowOptions[showIndex]) {
        const gebuehrVal = document.getElementById(`gebuehrValue${index}`).value;
        const gebuehrExtras = [];
        
        if (gebuehrVal) {
          const encoded = encodePrice(gebuehrVal);
          gebuehrExtras.push(encoded);
        }
        
        const gebuehrType = document.querySelector(`input[name="gebuehrType${index}"]:checked`);
        if (gebuehrType) {
          gebuehrExtras.push(gebuehrType.value);
        }
        
        const showName = koiShowOptions[showIndex];
        if (gebuehrExtras.length > 0) {
          parts.push(`${showName}${nextYear} (${gebuehrExtras.join(', ')})`);
        } else {
          parts.push(`${showName}${nextYear}`);
        }
      }
    });
  }
  
  const bemerkungen = document.getElementById('bemerkungen').value;
  if (bemerkungen) {
    parts.push(bemerkungen);
  }
  
  return parts.join('\n');
}

function updateTitle() {
  const fotosComplete = '26-' + document.getElementById('fotosNum').value;
  let bpriceEncoded = encodePrice(document.getElementById('bprice').value);
  const kpriceEncoded = encodePrice(document.getElementById('kprice').value);
  
  if (document.getElementById('bpricePercent').checked) {
    bpriceEncoded += '+%X';
  }
  
  const parts = [
    fotosComplete,
    document.getElementById('inputDate').value,
    document.getElementById('howToGet').value,
    document.getElementById('breederSelect').value,
    getAgentValue(),
    getDescriptionWithPrefix(),
    document.getElementById('qty').value,
    document.getElementById('oyaSelect').value || '',
    getAgeValue(),
    getRadioValue('sex'),
    getSizeValue(),
    bpriceEncoded,
    kpriceEncoded,
    getKundeValue()
  ];
  
  output.textContent = parts.join(', ');
}

function saveDefaults() {
  const defaults = {
    howToGet: document.getElementById('howToGet').value,
    breeder: document.getElementById('breederSelect').value,
    qty: document.getElementById('qty').value,
    age: getAgeValue(),
    sex: getRadioValue('sex'),
    kunde: getRadioValue('kunde'),
    kundeOther: document.getElementById('kundeOther').value
  };
  
  safeSetLocalStorage('koiDefaults', {
    defaults: defaults,
    timestamp: new Date().toISOString()
  });
}

function loadDefaults() {
  const data = safeGetLocalStorage('koiDefaults', null);
  if (!data) return;
  
  const defaults = data.defaults;
  
  if (defaults.howToGet) {
    document.getElementById('howToGet').value = defaults.howToGet;
  }
  
  if (defaults.breeder) {
    document.getElementById('breederSelect').value = defaults.breeder;
  }
  
  if (defaults.qty) document.getElementById('qty').value = defaults.qty;
  
  document.querySelectorAll('input[name="agent"]').forEach(cb => cb.checked = false);
  document.querySelector('input[name="agent"][value="YI"]').checked = true;
  
  if (defaults.kunde) {
    const kundeRadio = document.querySelector(`input[name="kunde"][value="${defaults.kunde}"]`);
    if (kundeRadio) {
      kundeRadio.checked = true;
      handleKundeChange();
    }
    if (defaults.kunde === 'Andere' && defaults.kundeOther) {
      document.getElementById('kundeOther').value = defaults.kundeOther;
    }
  }
  
  if (defaults.age) {
    if (defaults.age.includes('-')) {
      const [ageFrom, ageTo] = defaults.age.split('-');
      document.getElementById('ageFrom').value = ageFrom;
      document.getElementById('ageTo').value = ageTo;
    } else {
      document.getElementById('ageFrom').value = defaults.age;
    }
  }
  
  if (defaults.sex) {
    const sexRadio = document.querySelector(`input[name="sex"][value="${defaults.sex}"]`);
    if (sexRadio) sexRadio.checked = true;
  }
  
  document.getElementById('bprice').value = '';
  document.getElementById('kprice').value = '';
  document.getElementById('descriptionSelect').value = '';
  document.getElementById('oyaSelect').value = '';
  
  updateTitle();
}

function getNoteContent() {
  const title = output.textContent || "Koi Datenblatt";
  const body = getBemerkungenBody();
  return { title, body };
}

function copyToClipboard() {
  const { title, body } = getNoteContent();
  const fullText = `${title}\n${body}`;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(fullText).then(() => {
      showSuccess();
    }).catch(() => {
      fallbackCopy(fullText);
    });
  } else {
    fallbackCopy(fullText);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.left = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    showSuccess();
  } catch (err) {
    alert('Kopieren fehlgeschlagen. Bitte kopieren Sie den Text manuell.');
  }
  
  document.body.removeChild(textarea);
}

function showSuccess() {
  const msg = document.getElementById('successMsg');
  msg.style.display = 'block';
  setTimeout(() => { msg.style.display = 'none'; }, 5000);
}

function sendToKeep() {
  const fotoNumber = document.getElementById('fotosNum').value;
  if (fotoNumber) {
    saveFotoNumber(fotoNumber);
  }
  
  const dropdownFields = ['howToGet', 'breederSelect', 'oyaSelect', 'descriptionSelect', 'subSelect'];
  dropdownFields.forEach(fieldId => {
    const input = document.getElementById(fieldId);
    if (input && input.value && !dropdownOptions[fieldId].includes(input.value)) {
      addCustomOption(fieldId, input.value);
    }
  });
  
  saveDefaults();
  copyToClipboard();
  setTimeout(() => {
    openKeepOnly();
  }, 500);
}

function openKeepOnly() {
  window.open('https://keep.google.com', '_blank');
}

function saveOffline() {
  const { title, body } = getNoteContent();
  
  if (!title || title === "Koi Datenblatt") {
    alert('Bitte f√ºllen Sie zuerst das Formular aus.');
    return;
  }
  
  const note = {
    id: Date.now(),
    title: title,
    body: body,
    timestamp: new Date().toISOString(),
    fotoNumber: document.getElementById('fotosNum').value
  };
  
  if (note.fotoNumber) {
    saveFotoNumber(note.fotoNumber);
  }
  
  const dropdownFields = ['howToGet', 'breederSelect', 'oyaSelect', 'descriptionSelect', 'subSelect'];
  dropdownFields.forEach(fieldId => {
    const input = document.getElementById(fieldId);
    if (input && input.value && !dropdownOptions[fieldId].includes(input.value)) {
      addCustomOption(fieldId, input.value);
    }
  });
  
  const savedNotes = safeGetLocalStorage('offlineNotes', []);
  savedNotes.push(note);
  safeSetLocalStorage('offlineNotes', savedNotes);
  
  saveDefaults();
  
  const msg = document.getElementById('offlineMsg');
  msg.style.display = 'block';
  setTimeout(() => { msg.style.display = 'none'; }, 3000);
  
  updateSavedNotesCount();
}

function showSavedNotes() {
  const savedNotes = safeGetLocalStorage('offlineNotes', []);
  const modal = document.getElementById('savedNotesModal');
  const list = document.getElementById('savedNotesList');
  
  if (savedNotes.length === 0) {
    list.innerHTML = '<p style="text-align:center; color:#666;">Keine gespeicherten Notizen vorhanden.</p>';
  } else {
    list.innerHTML = savedNotes.reverse().map(note => `
      <div class="saved-note">
        <div class="saved-note-title">${escapeHtml(note.title)}</div>
        <div class="saved-note-date">Gespeichert: ${new Date(note.timestamp).toLocaleString('de-DE')}</div>
        <div class="saved-note-body">${escapeHtml(note.body) || '(keine weiteren Details)'}</div>
        <div class="saved-note-actions">
          <button onclick="copyNote(${note.id})" class="btn-copy" style="background:#28a745;">üìã Kopieren</button>
          <button onclick="deleteNote(${note.id})" class="btn-secondary" style="background:#dc3545;">üóëÔ∏è L√∂schen</button>
        </div>
      </div>
    `).join('');
  }
  
  modal.style.display = 'block';
}

function closeModal() {
  document.getElementById('savedNotesModal').style.display = 'none';
}

function copyNote(id) {
  const savedNotes = safeGetLocalStorage('offlineNotes', []);
  const note = savedNotes.find(n => n.id === id);
  
  if (note) {
    const fullText = `${note.title}\n${note.body}`;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(fullText).then(() => {
        alert('‚úÖ Notiz kopiert! Sie k√∂nnen sie jetzt in Google Keep einf√ºgen.');
      });
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = fullText;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      alert('‚úÖ Notiz kopiert! Sie k√∂nnen sie jetzt in Google Keep einf√ºgen.');
    }
  }
}

function deleteNote(id) {
  if (confirm('M√∂chten Sie diese Notiz wirklich l√∂schen?')) {
    let savedNotes = safeGetLocalStorage('offlineNotes', []);
    savedNotes = savedNotes.filter(n => n.id !== id);
    safeSetLocalStorage('offlineNotes', savedNotes);
    showSavedNotes();
    updateSavedNotesCount();
  }
}

function updateSavedNotesCount() {
  const savedNotes = safeGetLocalStorage('offlineNotes', []);
  const countElement = document.getElementById('noteCount');
  if (countElement) {
    countElement.textContent = savedNotes.length;
  }
}

function resetForm() {
  form.reset();
  document.getElementById("inputDate").value = new Date().toISOString().slice(2,10).replace(/-/g,'');
  document.querySelector('input[name="agent"][value="YI"]').checked = true;
  document.getElementById('ageFrom').value = '2';
  document.getElementById('ageTo').value = '';
  document.querySelector('input[name="sex"][value="w"]').checked = true;
  document.getElementById('howToGet').value = 'Tour KZ';
  document.getElementById('bprice').value = '';
  document.getElementById('kprice').value = '';
  document.getElementById('sizeFrom').value = '';
  document.getElementById('sizeTo').value = '';
  document.getElementById('kundeOther').style.display = 'none';
  document.getElementById('subContainer').style.display = 'none';
  document.getElementById('azukariValue').style.display = 'none';
  document.querySelectorAll('input[name="azukariType"]').forEach(rb => rb.checked = false);
  document.getElementById('gebuehrValue').style.display = 'none';
  document.querySelectorAll('input[name="gebuehrType"]').forEach(rb => rb.checked = false);
  document.getElementById('koiShowOptions').style.display = 'none';
  document.getElementById('koiShowAndereText').style.display = 'none';
  document.getElementById('additionalGebuehrContainer').innerHTML = '';
  
  document.querySelectorAll('.custom-dropdown').forEach(dd => dd.style.display = 'none');
  
  output.textContent = "";
  document.getElementById('successMsg').style.display = 'none';
  updateTitle();
}

function initializeForm() {
  document.getElementById("inputDate").value = new Date().toISOString().slice(2,10).replace(/-/g,'');
  
  document.querySelector('input[name="agent"][value="YI"]').checked = true;
  document.querySelectorAll('input[name="agent"]').forEach(cb => {
    if (cb.value !== 'YI') cb.checked = false;
  });
  
  document.getElementById('ageFrom').value = '2';
  
  setupCustomDropdown('howToGet', 'howToGetDropdown');
  setupCustomDropdown('breederSelect', 'breederDropdown');
  setupCustomDropdown('oyaSelect', 'oyaDropdown');
  setupCustomDropdown('descriptionSelect', 'descriptionDropdown');
  setupCustomDropdown('subSelect', 'subDropdown');
  
  document.getElementById("fotosNum").addEventListener("blur", formatFotoNumber);
  
  document.querySelectorAll('input[name="agent"]').forEach(cb => {
    cb.addEventListener("change", handleAgentChange);
  });
  
  document.querySelectorAll('input[name="kunde"]').forEach(rb => {
    rb.addEventListener("change", handleKundeChange);
  });
  
  document.getElementById("kundeSub").addEventListener("change", handleSubChange);
  document.getElementById("azukariCheck").addEventListener("change", handleAzukariChange);
  
  document.querySelectorAll('input[name="azukariType"]').forEach(rb => {
    rb.addEventListener("change", updateTitle);
  });
  
  document.getElementById("gebuehrCheck").addEventListener("change", handleGebuehrChange);
  
  document.querySelectorAll('input[name="gebuehrType"]').forEach(rb => {
    rb.addEventListener("change", updateTitle);
  });
  
  document.getElementById("koiShowCheck").addEventListener("change", handleKoiShowCheck);
  document.getElementById("koiShowAJKS").addEventListener("change", updateAdditionalGebuehrFields);
  document.getElementById("koiShowAJYKS").addEventListener("change", updateAdditionalGebuehrFields);
  document.getElementById("koiShowAndere").addEventListener("change", () => {
    handleKoiShowAndereChange();
    updateAdditionalGebuehrFields();
  });
  
  form.addEventListener("input", updateTitle);
  
  loadDefaults();
  updateSavedNotesCount();
  updateTitle();
}

window.addEventListener('DOMContentLoaded', initializeForm);
</script>

</body>
</html>